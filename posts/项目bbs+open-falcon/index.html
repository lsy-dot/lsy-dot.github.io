<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>项目(BBS&#43;open-falcon)</title>
    <meta name="description" content="项目(BBS&#43;open-falcon)">
    <meta name="keywords" content='项目'>

    <meta property="og:url" content="https://lsy-dot.github.io/posts/%E9%A1%B9%E7%9B%AEbbs&#43;open-falcon/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="项目(BBS&#43;open-falcon)">
    <meta property="og:description" content="项目(BBS&#43;open-falcon)">
    <meta property="og:image" content="../../static/images/image-20220829182427839.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="项目(BBS&#43;open-falcon)">
    <meta name="twitter:description" content="项目(BBS&#43;open-falcon)">
    <meta property="twitter:domain" content="https://lsy-dot.github.io/posts/%E9%A1%B9%E7%9B%AEbbs&#43;open-falcon/">
    <meta property="twitter:url" content="https://lsy-dot.github.io/posts/%E9%A1%B9%E7%9B%AEbbs&#43;open-falcon/">
    <meta name="twitter:image" content="../../static/images/image-20220829182427839.png">

    
    <link rel="canonical" href="https://lsy-dot.github.io/posts/%E9%A1%B9%E7%9B%AEbbs&#43;open-falcon/" />

    <link rel="stylesheet" type="text/css" href="https://lsy-dot.github.io//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://lsy-dot.github.io//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://lsy-dot.github.io//css/dark.css">

    <script src="https://lsy-dot.github.io//js/svg-injector.min.js"></script>
    <script src="https://lsy-dot.github.io//js/feather-icons.min.js"></script>
    <script src="https://lsy-dot.github.io//js/main.js"></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://lsy-dot.github.io/">
                <img src="https://lsy-dot.github.io/images/8531713.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://lsy-dot.github.io/">lsy-dot</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://lsy-dot.github.io/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://lsy-dot.github.io/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://lsy-dot.github.io/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://lsy-dot.github.io/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>项目(BBS&#43;open-falcon)</h1>
        <small role="doc-subtitle">项目(BBS&#43;open-falcon)</small>
        <p class="post-date">
            September 11, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://lsy-dot.github.io/tags/%E9%A1%B9%E7%9B%AE">项目</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="quote">quote</h1>
<p><strong>难道向上攀爬的过程不比站在顶峰更让人热血澎湃吗</strong></p>
<h1 id="参考链接">参考链接</h1>
<h1 id="bbs">BBS</h1>
<h2 id="简单介绍">简单介绍</h2>
<h3 id="功能">功能</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">这是一个基于SpringBoot的论坛项目，主要实现了
用户的登录、注册、关注
帖子的发布、删除、加精、置顶、检索
系统的通知
评论的点赞
热帖排行榜
等功能
</code></pre><h3 id="技术栈">技术栈</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">技术栈方面主要是
SpringBoot+Mybatis做了一个基本的功能实现
在这个基础上
引入了redis来缓存一些访问比较密集的数据，比如点赞的数量和关注的用户列表
引入了定时任务Quartz来实现热帖排行榜
引入了ES做帖子的内容检索
</code></pre><h3 id="数据库表">数据库表</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">用户表
id username password salt email
type 超管 版主 普通用户
status 未激活 已激活
activattion_code header_url create_time

discuss 帖子表
id user_id title content
type 普通 置顶
status 正常 精华 置顶
create_time comment_count score

comment 评论表
id user_id
entity_type 帖子的评论 评论的评论
entity_id 评论的id
target_id 评论目标的id
content status
create_time

message 消息表（私信消息、系统通知）
id
from_id 发送方
to_id 接受方
conversation_id from_id+to_id
content create_time
status 未读 已读 删除
</code></pre><h2 id="亮点和挑战">亮点和挑战</h2>
<h3 id="亮点">亮点</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">从整个项目来说，我觉得我在登录上花的精力比较多
版本1：数据库表login_ticket
缺点:频繁访问数据库
版本2:存redis
token采用jwt
但是引入jwt需要考虑他的失效，考虑加了黑名单，设置了过期时间。

使用了redis的的hyperlog和bitmap统计
DAU、UV

事务
注册时，写入数据库和发邮件
扯一下Spring的事务
</code></pre><h3 id="压测调优">压测调优</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">讲下压测工具，流程

数据库调优
查帖子对应的评论加上索引，加快查询。
说下索引的三星原则
	where 过滤
	排序  
	select 覆盖索引
分页查询limit先偏移再查

jvm调优
讲下gc的流程
把堆的大小调大一些。
threadlocal用完要remove
扯一扯线程池
</code></pre><h3 id="redis相关问题">redis相关问题</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">点赞 维护key-value 实体-点赞实体（人）的id 用户-用户获得的点赞数量
关注 维护key-value 用户+实体类型-实体id（用户关注了那些实体） 实体id+实体类型-用户id（实体被那些用户关注了）

redis持久化问题
</code></pre><h2 id="改进方向">改进方向</h2>
<pre tabindex="0"><code class="language-a" data-lang="a">改成分布式，用SpringCloud微服务
nginx+gateway，
nginx负载均衡的三种方式
轮询、权重、ip_hash

mysql改成主从架构，主从复制，读写分离
</code></pre><h1 id="open-falcon">open-falcon</h1>
<h2 id="简单介绍-1">简单介绍</h2>
<h3 id="任务">任务</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">1，消息队列的监控告警，主要是监控每个队列里消息情况，包括空闲，消息积压，消费者列表，也可以涵盖消息队列的性能监控。

监控指标
整体
单实例
</code></pre><h3 id="rabbitmq问题">rabbitmq问题</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">基础架构
producer-&gt;exchange-&gt;queue-&gt;consumer

MQ的模式
1、简单模式[一个生产者一个消费者]
2、work模式[一个生产者多个消费者]
3、订阅模式[work模式中间加个交换机]
4、路由模式[交换机加上一个key进行匹配才发送消息]
5、Topic模式[key变成topic进行模糊匹配]
6、RPC

4种类型的Exchange
1、direct（精确匹配）
2、fanout（广播）
3、topic（通配符）
4、headers（设置头部属性）


1、如何确保消息不丢失
先说哪里可能丢失消息，无非三个地方
生产者-&gt;队列-&gt;消费者
手段就是开启消息确认机制，和持久化机制。
2、如何处理消息积压
多开机器、先把消息存数据库再慢慢消化

3、rabbtimq如何实现延迟队列、死信队列？
延迟队列：见上文，一个是用TTL参数+DLX，一个是delay_que
死信队列：自带DLX
4、消息队列如何限流？（https://segmentfault.com/a/1190000023859065?utm_source=sf-similar-article）
设置prefetch参数


2、rabbitmq如何保证消息消费有序、幂等、不重复消费、可靠？
消费有序：如果是多个consumer消费一个queue，那么怎样都无法保证，只能将需要保证有序的消息分在一个queue让一个consumer去消费才可以
幂等：全局id存redis，设置可承受的过期时间，如果设置了过期时间，那么为了保证唯一性还需要再mysql中存一份数据
不重复消费：和幂等一样
可靠性（https://segmentfault.com/a/1190000023736395）：  producer-&gt;exchange-&gt;queue-&gt;consumer     
第一步：开启发送方确认机制，回调函数处理
第二步：策略（自动删除和返回客户端[选择]）
第三步：开启queue和exchange的持久化机制
第四步：开启消费者手动确认消息
加一个定时任务扫描备份队列or数据库（消息先存数据库，消费完成后更改其状态）进行重写投递。


消息队列选择
https://www.infoq.cn/article/kafka-vs-rabbitmq
功能维度
	优先级队列
	延迟队列
	死信队列
	重试队列
	消费模式(push,pull)
	广播消费
	消息回溯（消息消费完还能找到，rabbitmq没有，kafka有）
	消息堆积 + 持久化(kafka存磁盘，rabbitmq存内存)
	消息追踪
	消息过滤
	多租户(rabbitmq的vhost)
	多协议支持
	跨语言支持
	流量控制
	消息顺序性
	安全机制
	消息幂等性
	事务性消息
时延
可靠性+可用性
</code></pre><h3 id="技术框架open-falcon">技术框架(open-falcon)</h3>
<pre tabindex="0"><code class="language-a" data-lang="a">基础组件
agent:采集并上报监控数据
transfer：数据转发，哈希分片
center status:mysql(hostgroup、报警策略等)、redis(报警缓存队列)

作图链路组件
graph:分片存储绘图数据
query：提供查询接口，屏蔽分片细节
dashboard:监控数据图表展示(web)

报警链路组件
judge：报警策略触发
hbs:心跳机制，保活agent，维护host表
nodata：检测监控上报异常
aggr:集群整体指标视角
alarm/sender/links:整合报警信息，发送和展示
portal:监控策略管理(web)
uic:用户信息管理(web)
</code></pre><h2 id="遇到问题和解决办法">遇到问题和解决办法</h2>
<pre tabindex="0"><code class="language-a" data-lang="a">1、问题：
通过open-falcon提供的自监控功能，发现自定义监控项单次发送长度过大时，可能造成数据堆积。
由于agent对metric的最大发送长度没有限制，当业务通过agent push接口推送长度很大的metric时，会造成transfer的数据发送堆积
2、解决办法
（1）增加配置，限制agent接收metric的最大长度，来尽量避免此问题
（2）单次发送metric的长度限制为固定条数（30），可调整
</code></pre><h1 id="商城todo-">商城(todo )</h1>
<h2 id="简单介绍-2">简单介绍</h2>
<h3 id="功能模块">功能模块</h3>
<h3 id="技术栈-1">技术栈</h3>
<h2 id="遇到问题和解决办法-1">遇到问题和解决办法</h2>

        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#quote">quote</a></li>
    <li><a href="#参考链接">参考链接</a></li>
    <li><a href="#bbs">BBS</a>
      <ul>
        <li><a href="#简单介绍">简单介绍</a>
          <ul>
            <li><a href="#功能">功能</a></li>
            <li><a href="#技术栈">技术栈</a></li>
            <li><a href="#数据库表">数据库表</a></li>
          </ul>
        </li>
        <li><a href="#亮点和挑战">亮点和挑战</a>
          <ul>
            <li><a href="#亮点">亮点</a></li>
            <li><a href="#压测调优">压测调优</a></li>
            <li><a href="#redis相关问题">redis相关问题</a></li>
          </ul>
        </li>
        <li><a href="#改进方向">改进方向</a></li>
      </ul>
    </li>
    <li><a href="#open-falcon">open-falcon</a>
      <ul>
        <li><a href="#简单介绍-1">简单介绍</a>
          <ul>
            <li><a href="#任务">任务</a></li>
            <li><a href="#rabbitmq问题">rabbitmq问题</a></li>
            <li><a href="#技术框架open-falcon">技术框架(open-falcon)</a></li>
          </ul>
        </li>
        <li><a href="#遇到问题和解决办法">遇到问题和解决办法</a></li>
      </ul>
    </li>
    <li><a href="#商城todo-">商城(todo )</a>
      <ul>
        <li><a href="#简单介绍-2">简单介绍</a>
          <ul>
            <li><a href="#功能模块">功能模块</a></li>
            <li><a href="#技术栈-1">技术栈</a></li>
          </ul>
        </li>
        <li><a href="#遇到问题和解决办法-1">遇到问题和解决办法</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 lsy-dot</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
